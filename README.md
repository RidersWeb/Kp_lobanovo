# Telegram Bot - Вахтер для коттеджного поселка

Бот для автоматизации регистрации жильцов и выдачи доступа в закрытую группу Telegram.

## Установка

1. Клонируйте репозиторий или создайте проект
2. Установите зависимости:
```bash
pip install -r requirements.txt
```

3. Создайте файл `.env` в корне проекта со следующим содержимым:
```env
BOT_TOKEN=your_bot_token_here
ADMIN_IDS=123456789,987654321
GROUP_ID=your_group_chat_id_here
```

4. Заполните `.env` файл:
   - **BOT_TOKEN** - токен бота от @BotFather (создайте бота через @BotFather в Telegram)
   - **ADMIN_IDS** - ID администраторов через запятую (можно узнать у @userinfobot). Поддерживается несколько админов.
   - **GROUP_ID** - ID группы, в которую будут приглашаться пользователи (можно узнать у @getidsbot или добавив бота в группу)
   
   **Примечание:** Для обратной совместимости можно использовать `ADMIN_ID` вместо `ADMIN_IDS`, но рекомендуется использовать `ADMIN_IDS` для поддержки нескольких админов.

## Запуск

```bash
# Установка зависимостей
pip install -r requirements.txt

# Создайте файл .env с токенами
# BOT_TOKEN=your_bot_token
# ADMIN_IDS=your_admin_ids
# GROUP_ID=your_group_id

# Запуск
python main.py
```

## Функционал

1. **Регистрация пользователей:**
   - Команда `/start` запускает процесс регистрации
   - Пошаговый ввод: ФИО, телефон, номер участка, фото документа
   - Валидация данных на каждом этапе
   - Обработка ошибок и некорректных данных

2. **Модерация:**
   - Все админы получают уведомления о новых заявках с полной информацией
   - Кнопки "Одобрить" и "Отклонить" для быстрой модерации
   - Просмотр документов пользователей
   - Поддержка нескольких администраторов

3. **Поиск пользователей (только для админов):**
   - `/search` - универсальный поиск по всем полям
   - `/search_plot [номер участка]` - поиск по номеру участка
   - `/search_phone [номер телефона]` - поиск по номеру телефона
   - `/search_name [ФИО]` - поиск по ФИО
   - При поиске выводятся все данные пользователя, включая документы

4. **Выдача доступа:**
   - Одобренным пользователям автоматически генерируется одноразовая ссылка-приглашение в группу
   - Ссылка отправляется пользователю с инструкциями

5. **База данных:**
   - Все данные хранятся локально в SQLite (`village.db`)
   - Отслеживание статусов заявок (pending, approved, rejected)
   - Защита от повторной регистрации

6. **Логирование:**
   - Все действия логируются в файл `bot.log`
   - Логи также выводятся в консоль

## Команды для админов

- `/admin` - открыть админ-меню с кнопками поиска
- `/search` - начать поиск пользователей (универсальный поиск)
- `/search_plot [номер]` - поиск по номеру участка
- `/search_phone [номер]` - поиск по номеру телефона  
- `/search_name [ФИО]` - поиск по ФИО

Примеры:
```
/search_plot 50:28:0090247
/search_phone +79001234567
/search_name Иванов Иван
```

## Безопасность

Бот включает следующие меры безопасности:

1. **Валидация входных данных:**
   - Проверка длины полей
   - Валидация формата данных (ФИО, телефон, номер участка)
   - Санитизация текста (удаление опасных символов, экранирование HTML)

2. **Защита от SQL-инъекций:**
   - Все запросы к БД используют параметризованные запросы

3. **Защита от XSS:**
   - HTML-экранирование всех пользовательских данных

4. **Валидация файлов:**
   - Проверка расширений файлов (только разрешенные форматы)
   - Проверка размера файлов (максимум 20 МБ)
   - Блокировка выполнения скриптов

5. **Нормализация телефонов:**
   - Автоматическое добавление "+" к номеру телефона
   - Преобразование формата (8 -> +7)

6. **Проверка прав доступа:**
   - Все админ-команды проверяют права пользователя

## Структура проекта

```
.
├── main.py              # Точка входа
├── config.py            # Конфигурация
├── database.py          # Работа с БД
├── states.py            # FSM состояния
├── handlers/            # Обработчики
│   ├── __init__.py
│   ├── start.py
│   ├── registration.py
│   ├── admin.py
│   ├── search.py        # Поиск для админов
│   └── admin_menu.py    # Админ-меню
├── security.py          # Модуль безопасности
├── requirements.txt     # Зависимости
├── .env                 # Конфигурация (не в git)
└── village.db           # База данных (создается автоматически)
```

